/**
 * 주식 지표 분석 및 점수화 시스템 (6가지 지표 평가)
 */

// 7가지 지표별 평가 기준
const INDICATOR_EVALUATIONS = {
  // 1. 오버뷰 평가
  오버뷰평가: {
    상대적거래량: {
      지표명: "relative_volume_10d_calc",
      한글명: "상대적 거래량",
      단계별범위: {
        매우낮음: { min: 0, max: 0.5, score: 1 },
        낮음: { min: 0.5, max: 0.8, score: 2 },
        적정: { min: 0.8, max: 1.2, score: 3 },
        높음: { min: 1.2, max: 2.0, score: 4 },
        매우높음: { min: 2.0, max: Infinity, score: 5 },
      },
      단계별해석: {
        매우낮음:
          "거래량이 평소보다 매우 적어요. 관심이 낮거나 유동성이 부족할 수 있습니다 😕",
        낮음: "거래량이 평소보다 적어요. 시장 참여가 소극적인 상황입니다 😐",
        적정: "적정한 거래량 수준이에요. 평소와 비슷한 관심도를 보이고 있어요 😊",
        높음: "거래량이 평소보다 많아요! 시장의 관심이 높아지고 있습니다 👍",
        매우높음:
          "거래량이 폭증했어요! 중요한 이슈나 변화가 있을 수 있습니다 🚀",
      },
    },
    애널리스트평점: {
      지표명: "recommendation_mark",
      한글명: "애널리스트 평점",
      단계별범위: {
        매우낮음: { min: 0, max: 0.5, score: 1 },
        낮음: { min: 0.5, max: 1.0, score: 2 },
        적정: { min: 1.0, max: 1.5, score: 3 },
        양호: { min: 1.5, max: 2.0, score: 4 },
        매우우수: { min: 2.0, max: Infinity, score: 5 },
      },
      단계별해석: {
        매우낮음:
          "애널리스트들이 매우 부정적으로 평가하고 있어요. 투자에 주의가 필요합니다 😰",
        낮음: "애널리스트들이 다소 부정적으로 평가하고 있어요. 신중한 접근이 필요해요 😕",
        적정: "애널리스트들이 중립적으로 평가하고 있어요. 균형잡힌 시각을 보이고 있습니다 😊",
        양호: "애널리스트들이 긍정적으로 평가하고 있어요! 전문가들의 신뢰를 받고 있습니다 👍",
        매우우수:
          "애널리스트들이 매우 긍정적으로 평가하고 있어요! 강력한 매수 추천을 받고 있습니다 🚀",
      },
    },
    목표가실적: {
      지표명: "price_target_1y_delta",
      한글명: "목표가 실적 %",
      단계별범위: {
        매우부정적: { min: -Infinity, max: -20, score: 1 },
        부정적: { min: -20, max: -5, score: 2 },
        적정: { min: -5, max: 15, score: 3 },
        양호: { min: 15, max: 40, score: 4 },
        매우우수: { min: 40, max: Infinity, score: 5 },
      },
      단계별해석: {
        매우부정적:
          "목표가 대비 현재 주가가 크게 높아요. 고평가 위험이 있을 수 있습니다 😰",
        부정적:
          "목표가 대비 현재 주가가 다소 높아요. 상승 여력이 제한적일 수 있어요 😕",
        적정: "목표가 대비 적정한 주가 수준이에요. 합리적인 가격으로 평가됩니다 😊",
        양호: "목표가 대비 상승 여력이 있어요! 추가 상승 가능성을 보여줍니다 👍",
        매우우수:
          "목표가 대비 상당한 상승 여력이 있어요! 큰 상승 잠재력을 가지고 있습니다 🚀",
      },
    },
  },

  // 2. 손익계산 평가
  손익계산평가: {
    매출성장률: {
      지표명: "total_revenue_yoy_growth_ttm",
      한글명: "매출 성장률 %",
      단계별범위: {
        매우부정적: { min: -Infinity, max: -20, score: 1 },
        부정적: { min: -20, max: 0, score: 2 },
        적정: { min: 0, max: 15, score: 3 },
        양호: { min: 15, max: 30, score: 4 },
        매우우수: { min: 30, max: Infinity, score: 5 },
      },
      단계별해석: {
        매우부정적:
          "매출이 크게 감소하고 있어요. 사업 기반이 흔들리고 있을 수 있습니다 😰",
        부정적:
          "매출이 감소하고 있어요. 시장 상황이나 경쟁력을 점검해봐야 합니다 😕",
        적정: "안정적인 매출 성장을 보이고 있어요. 꾸준한 성장세를 유지하고 있습니다 😊",
        양호: "좋은 매출 성장률이에요! 시장에서 좋은 성과를 거두고 있습니다 👍",
        매우우수:
          "매우 높은 매출 성장률이에요! 폭발적인 성장을 하고 있는 기업입니다 🚀",
      },
    },
    EPS희석성장: {
      지표명: "earnings_per_share_diluted_yoy_growth_ttm",
      한글명: "희석 주당순이익 성장률 %",
      단계별범위: {
        매우부정적: { min: -Infinity, max: -50, score: 1 },
        부정적: { min: -50, max: 0, score: 2 },
        적정: { min: 0, max: 25, score: 3 },
        양호: { min: 25, max: 50, score: 4 },
        매우우수: { min: 50, max: Infinity, score: 5 },
      },
      단계별해석: {
        매우부정적:
          "주당순이익이 크게 감소했어요. 수익성이 급격히 악화되고 있습니다 😰",
        부정적: "주당순이익이 감소했어요. 수익성 개선이 필요한 상황입니다 😕",
        적정: "안정적인 주당순이익 성장을 보이고 있어요. 꾸준한 수익 증가세입니다 😊",
        양호: "좋은 주당순이익 성장률이에요! 수익성이 크게 개선되고 있습니다 👍",
        매우우수:
          "매우 높은 주당순이익 성장률이에요! 폭발적인 수익 증가를 보이고 있습니다 🚀",
      },
    },
  },

  // 2. 수익성 지표 평가
  수익성지표평가: {
    총마진: {
      지표명: "gross_margin_ttm",
      한글명: "총마진%",
      단계별범위: {
        매우낮음: { min: -Infinity, max: 0, score: 1 },
        낮음: { min: 0, max: 20, score: 2 },
        적정: { min: 20, max: 40, score: 3 },
        양호: { min: 40, max: 60, score: 4 },
        매우우수: { min: 60, max: Infinity, score: 5 },
      },
      단계별해석: {
        매우낮음:
          "총마진이 음수예요. 원가가 매출보다 높아 매우 위험한 상황입니다 😰",
        낮음: "총마진이 낮아요. 원가 관리나 가격 정책을 개선할 필요가 있어 보여요 😕",
        적정: "적정한 총마진이에요. 기본적인 수익성은 확보하고 있어요 😊",
        양호: "좋은 총마진이에요! 제품/서비스의 경쟁력이 우수합니다 👍",
        매우우수:
          "매우 높은 총마진이에요! 강력한 경쟁우위를 가진 사업모델입니다 🚀",
      },
    },
    영업마진: {
      지표명: "operating_margin_ttm",
      한글명: "영업마진%",
      단계별범위: {
        매우낮음: { min: -Infinity, max: 0, score: 1 },
        낮음: { min: 0, max: 5, score: 2 },
        적정: { min: 5, max: 15, score: 3 },
        양호: { min: 15, max: 25, score: 4 },
        매우우수: { min: 25, max: Infinity, score: 5 },
      },
      단계별해석: {
        매우낮음: "영업적자 상태예요. 사업 구조 개선이 시급합니다 😰",
        낮음: "영업마진이 낮아요. 운영 효율성을 높일 필요가 있어요 😕",
        적정: "적당한 영업마진이에요. 기본적인 사업성은 확보했어요 😊",
        양호: "좋은 영업마진이에요! 효율적인 운영을 하고 있습니다 👍",
        매우우수:
          "매우 높은 영업마진이에요! 탁월한 운영 효율성을 보여줍니다 🚀",
      },
    },
    ROA: {
      지표명: "return_on_assets_fq",
      한글명: "총자산 이익률 %",
      단계별범위: {
        매우낮음: { min: -Infinity, max: 0, score: 1 },
        낮음: { min: 0, max: 5, score: 2 },
        적정: { min: 5, max: 10, score: 3 },
        양호: { min: 10, max: 20, score: 4 },
        매우우수: { min: 20, max: Infinity, score: 5 },
      },
      단계별해석: {
        매우낮음:
          "자산 대비 손실을 내고 있어요. 자산 활용도가 매우 낮습니다 😰",
        낮음: "자산 활용도가 낮아요. 자산 효율성을 높일 필요가 있어요 😕",
        적정: "적정한 자산 수익률이에요. 자산을 잘 활용하고 있어요 😊",
        양호: "좋은 자산 수익률이에요! 효율적인 자산 운용을 하고 있습니다 👍",
        매우우수:
          "매우 높은 자산 수익률이에요! 탁월한 자산 활용 능력을 보여줍니다 🚀",
      },
    },
    ROE: {
      지표명: "return_on_equity_fq",
      한글명: "자기자본 수익률 %",
      단계별범위: {
        매우낮음: { min: -Infinity, max: 0, score: 1 },
        낮음: { min: 0, max: 8, score: 2 },
        적정: { min: 8, max: 15, score: 3 },
        양호: { min: 15, max: 25, score: 4 },
        매우우수: { min: 25, max: Infinity, score: 5 },
      },
      단계별해석: {
        매우낮음:
          "주주 투자금 대비 손실을 내고 있어요. 주주가치 훼손 상태입니다 😰",
        낮음: "주주 수익률이 낮아요. 주주가치 창출력이 부족합니다 😕",
        적정: "적정한 주주 수익률이에요. 안정적인 주주가치를 창출하고 있어요 😊",
        양호: "좋은 주주 수익률이에요! 주주가치 창출에 우수합니다 👍",
        매우우수:
          "매우 높은 주주 수익률이에요! 뛰어난 주주가치 창출 능력입니다 🚀",
      },
    },
    세전마진: {
      지표명: "pre_tax_margin_ttm",
      한글명: "세전마진%",
      단계별범위: {
        매우낮음: { min: -Infinity, max: 0, score: 1 },
        낮음: { min: 0, max: 5, score: 2 },
        적정: { min: 5, max: 15, score: 3 },
        양호: { min: 15, max: 25, score: 4 },
        매우우수: { min: 25, max: Infinity, score: 5 },
      },
      단계별해석: {
        매우낮음: "세전손실 상태예요. 전반적인 수익성 개선이 필요합니다 😰",
        낮음: "세전마진이 낮아요. 이자비용이나 기타비용을 점검해보세요 😕",
        적정: "적정한 세전마진이에요. 안정적인 수익을 내고 있어요 😊",
        양호: "좋은 세전마진이에요! 건실한 수익 구조를 가지고 있습니다 👍",
        매우우수: "매우 높은 세전마진이에요! 뛰어난 수익성을 보여줍니다 🚀",
      },
    },
    FCF마진: {
      지표명: "free_cash_flow_margin_ttm",
      한글명: "잉여 현금 흐름 마진 %",
      단계별범위: {
        매우낮음: { min: -Infinity, max: 0, score: 1 },
        낮음: { min: 0, max: 5, score: 2 },
        적정: { min: 5, max: 15, score: 3 },
        양호: { min: 15, max: 25, score: 4 },
        매우우수: { min: 25, max: Infinity, score: 5 },
      },
      단계별해석: {
        매우낮음:
          "현금창출력이 부족해요. 투자나 부채상환에 어려움이 있을 수 있어요 😰",
        낮음: "현금창출력이 약해요. 현금흐름 개선이 필요합니다 😕",
        적정: "적정한 현금창출력이에요. 안정적인 현금흐름을 유지하고 있어요 😊",
        양호: "좋은 현금창출력이에요! 투자 여력이 충분합니다 👍",
        매우우수: "매우 높은 현금창출력이에요! 강력한 캐시카우 사업입니다 🚀",
      },
    },
    투하자본수익률: {
      지표명: "return_on_invested_capital_fq",
      한글명: "투하자본 수익률 %",
      단계별범위: {
        매우낮음: { min: -Infinity, max: 0, score: 1 },
        낮음: { min: 0, max: 6, score: 2 },
        적정: { min: 6, max: 12, score: 3 },
        양호: { min: 12, max: 20, score: 4 },
        매우우수: { min: 20, max: Infinity, score: 5 },
      },
      단계별해석: {
        매우낮음:
          "투자한 자본에서 손실이 발생하고 있어요. 투자 효율성이 매우 낮습니다 😰",
        낮음: "투하자본 수익률이 낮아요. 자본 배분 전략을 재검토해야 합니다 😕",
        적정: "적정한 투하자본 수익률이에요. 투자 효율성이 적절합니다 😊",
        양호: "좋은 투하자본 수익률이에요! 효과적인 자본 운용을 하고 있습니다 👍",
        매우우수:
          "매우 높은 투하자본 수익률이에요! 탁월한 투자 효율성을 보여줍니다 🚀",
      },
    },
    판관비율: {
      지표명: "sell_gen_admin_exp_other_ratio_ttm",
      한글명: "판매, 일반 및 관리 비용 비율",
      단계별범위: {
        매우우수: { min: -Infinity, max: 10, score: 5 },
        양호: { min: 10, max: 20, score: 4 },
        적정: { min: 20, max: 35, score: 3 },
        높음: { min: 35, max: 50, score: 2 },
        매우높음: { min: 50, max: Infinity, score: 1 },
      },
      단계별해석: {
        매우우수: "매우 낮은 판관비율이에요! 운영 효율성이 뛰어납니다 🚀",
        양호: "낮은 판관비율이에요! 효율적인 운영을 하고 있습니다 👍",
        적정: "적정한 판관비율이에요. 일반적인 수준의 운영비용입니다 😊",
        높음: "판관비율이 높아요. 운영비용 절감을 검토해볼 필요가 있어요 😕",
        매우높음: "판관비율이 매우 높아요. 운영 효율성 개선이 시급합니다 😰",
      },
    },
  },

  // 3. 배당 지표 평가
  배당지표평가: {
    연속배당지급: {
      지표명: "continuous_dividend_payout",
      한글명: "지속적인 배당금 지급 (년)",
      단계별범위: {
        매우낮음: { min: 0, max: 2, score: 1 },
        낮음: { min: 3, max: 5, score: 2 },
        적정: { min: 6, max: 10, score: 3 },
        양호: { min: 11, max: 15, score: 4 },
        매우우수: { min: 16, max: Infinity, score: 5 },
      },
      단계별해석: {
        매우낮음:
          "배당 이력이 짧아요. 아직 배당 정책이 안정화되지 않았을 수 있어요 🤷‍♂️",
        낮음: "배당 이력이 비교적 짧아요. 배당의 지속성을 좀 더 지켜봐야겠어요 🤔",
        적정: "적당한 배당 이력을 가지고 있어요. 어느 정도 신뢰할 수 있는 수준이에요 😊",
        양호: "오랫동안 꾸준히 배당을 지급해왔어요. 안정적인 배당주로 볼 수 있어요 👍",
        매우우수:
          "매우 오랜 기간 배당을 유지해온 우량 배당주예요! 신뢰도가 매우 높습니다 💎",
      },
    },
    연속배당증가: {
      지표명: "continuous_dividend_growth",
      한글명: "지속적인 배당금 증가 (년)",
      단계별범위: {
        매우낮음: { min: 0, max: 2, score: 1 },
        낮음: { min: 3, max: 5, score: 2 },
        적정: { min: 6, max: 10, score: 3 },
        양호: { min: 11, max: 15, score: 4 },
        매우우수: { min: 16, max: Infinity, score: 5 },
      },
    },
    배당수익률: {
      지표명: "dividends_yield_current",
      한글명: "현재 배당 수익률 %",
      단계별범위: {
        매우낮음: { min: 0, max: 1, score: 1 },
        낮음: { min: 1, max: 2, score: 2 },
        적정: { min: 2, max: 4, score: 3 },
        양호: { min: 4, max: 7, score: 5 },
        매우높음: { min: 7, max: Infinity, score: 2 },
      },
      단계별해석: {
        매우낮음:
          "배당 증가 이력이 짧아요. 앞으로의 배당 증가를 지켜봐야겠어요 🌱",
        낮음: "몇 년간 배당을 늘려왔어요. 이 추세가 계속될지 관심을 가져보세요 📈",
        적정: "꾸준히 배당을 늘려온 회사예요. 배당 성장주로서 매력이 있어요 😊",
        양호: "오랫동안 배당을 지속적으로 늘려왔어요. 훌륭한 배당 성장주입니다 🚀",
        매우우수:
          "배당킹(Dividend King) 수준이에요! 최고급 배당 성장주로 인정받는 기업입니다 👑",
      },
    },
  },

  // 4. 대차대조표 평가
  대차대조표평가: {
    유동비율: {
      지표명: "current_ratio_fq",
      한글명: "유동비율",
      단계별범위: {
        매우위험: { min: -Infinity, max: 1.0, score: 1 },
        위험: { min: 1.0, max: 1.5, score: 2 },
        적정: { min: 1.5, max: 2.5, score: 3 },
        양호: { min: 2.5, max: 4.0, score: 4 },
        매우우수: { min: 4.0, max: Infinity, score: 5 },
      },
      단계별해석: {
        매우위험:
          "단기 지급능력이 매우 부족해요. 유동성 위기에 직면할 수 있습니다 😰",
        위험: "단기 지급능력이 부족해요. 현금흐름 관리에 주의가 필요합니다 😕",
        적정: "적정한 유동성을 유지하고 있어요. 단기 채무 상환에 무리가 없어요 😊",
        양호: "좋은 유동성을 가지고 있어요! 단기 재무 안정성이 우수합니다 👍",
        매우우수:
          "매우 높은 유동성이에요! 단기 지급능력이 탁월하지만 자금 활용도는 점검해보세요 💰",
      },
    },
    당좌비율: {
      지표명: "quick_ratio_fq",
      한글명: "당좌비율",
      단계별범위: {
        매우위험: { min: -Infinity, max: 0.5, score: 1 },
        위험: { min: 0.5, max: 0.8, score: 2 },
        적정: { min: 0.8, max: 1.5, score: 3 },
        양호: { min: 1.5, max: 2.5, score: 4 },
        매우우수: { min: 2.5, max: Infinity, score: 5 },
      },
      단계별해석: {
        매우위험:
          "즉시 현금화 가능한 자산이 매우 부족해요. 긴급 지급 상황에 위험합니다 😰",
        위험: "당좌자산이 부족해요. 즉시 현금화할 수 있는 자산을 늘려야 합니다 😕",
        적정: "적정한 당좌비율이에요. 급한 지급상황에 대응할 수 있어요 😊",
        양호: "좋은 당좌비율이에요! 즉시 지급능력이 우수합니다 👍",
        매우우수:
          "매우 높은 당좌비율이에요! 탁월한 즉시 지급능력을 보유하고 있습니다 💎",
      },
    },
    부채비율: {
      지표명: "debt_to_equity_fq",
      한글명: "부채 대 자본 비율",
      단계별범위: {
        매우우수: { min: -Infinity, max: 0.3, score: 5 },
        양호: { min: 0.3, max: 0.6, score: 4 },
        적정: { min: 0.6, max: 1.0, score: 3 },
        위험: { min: 1.0, max: 2.0, score: 2 },
        매우위험: { min: 2.0, max: Infinity, score: 1 },
      },
      단계별해석: {
        매우우수: "매우 낮은 부채비율이에요! 재무구조가 매우 안전합니다 💎",
        양호: "낮은 부채비율이에요! 안정적인 재무구조를 가지고 있습니다 👍",
        적정: "적정한 부채비율이에요. 건전한 재무 레버리지를 유지하고 있어요 😊",
        위험: "부채비율이 높아요. 재무 위험이 증가하고 있으니 주의가 필요합니다 😕",
        매우위험:
          "부채비율이 매우 높아요! 재무 위험이 매우 크니 신중하게 접근하세요 😰",
      },
    },
    현금부채비율: {
      지표명: "cash_n_short_term_invest_to_total_debt_fq",
      한글명: "현금 및 단기 투자 대 총 부채 비율",
      단계별범위: {
        매우낮음: { min: -Infinity, max: 0.1, score: 1 },
        낮음: { min: 0.1, max: 0.3, score: 2 },
        적정: { min: 0.3, max: 0.6, score: 3 },
        양호: { min: 0.6, max: 1.0, score: 4 },
        매우우수: { min: 1.0, max: Infinity, score: 5 },
      },
      단계별해석: {
        매우낮음:
          "현금 보유량이 부채 대비 매우 부족해요. 부채 상환 능력이 제한적입니다 😰",
        낮음: "현금 보유량이 부족해요. 부채 관리에 어려움이 있을 수 있어요 😕",
        적정: "적정한 현금 보유량이에요. 부채 상환에 무리가 없어요 😊",
        양호: "풍부한 현금 보유량이에요! 부채 상환 능력이 우수합니다 👍",
        매우우수:
          "매우 많은 현금을 보유하고 있어요! 부채를 언제든 상환할 수 있는 능력이 있습니다 💰",
      },
    },
  },

  // 5. 기술등급 평가
  기술등급평가: {
    기술등급: {
      지표명: "recommend_all",
      한글명: "테크니컬 레이팅",
      단계별범위: {
        적극매도: { min: -Infinity, max: -0.4, score: 1 },
        매도: { min: -0.4, max: -0.15, score: 2 },
        중립: { min: -0.15, max: 0.15, score: 3 },
        매수: { min: 0.15, max: 0.4, score: 4 },
        적극매수: { min: 0.4, max: Infinity, score: 5 },
      },
      단계별해석: {
        적극매도:
          "기술적 분석 신호가 매우 부정적이에요. 매도를 고려해보세요 📉",
        매도: "기술적 분석 신호가 부정적이에요. 신중한 접근이 필요합니다 😕",
        중립: "기술적 분석 신호가 중립적이에요. 추가 신호를 기다려보세요 😐",
        매수: "기술적 분석 신호가 긍정적이에요! 매수를 고려해볼만 합니다 👍",
        적극매수:
          "기술적 분석 신호가 매우 긍정적이에요! 강력한 매수 신호입니다 🚀",
      },
    },
    MA레이팅: {
      지표명: "recommend_m_a",
      한글명: "무빙 애버리지 레이팅",
      단계별범위: {
        적극매도: { min: -Infinity, max: -0.4, score: 1 },
        매도: { min: -0.4, max: -0.15, score: 2 },
        중립: { min: -0.15, max: 0.15, score: 3 },
        매수: { min: 0.15, max: 0.4, score: 4 },
        적극매수: { min: 0.4, max: Infinity, score: 5 },
      },
      단계별해석: {
        적극매도:
          "이동평균선이 강한 하락 신호를 보이고 있어요. 하락 추세가 뚜렷합니다 📉",
        매도: "이동평균선이 하락 신호를 보이고 있어요. 단기 조정이 예상됩니다 😕",
        중립: "이동평균선이 혼조세를 보이고 있어요. 방향성이 불분명합니다 😐",
        매수: "이동평균선이 상승 신호를 보이고 있어요! 상승 추세 진입 가능성이 있습니다 👍",
        적극매수:
          "이동평균선이 강한 상승 신호를 보이고 있어요! 뚜렷한 상승 추세입니다 🚀",
      },
    },
    OS등급: {
      지표명: "recommend_other",
      한글명: "오실레이터 레이팅",
      단계별범위: {
        적극매도: { min: -Infinity, max: -0.4, score: 1 },
        매도: { min: -0.4, max: -0.15, score: 2 },
        중립: { min: -0.15, max: 0.15, score: 3 },
        매수: { min: 0.15, max: 0.4, score: 4 },
        적극매수: { min: 0.4, max: Infinity, score: 5 },
      },
      단계별해석: {
        적극매도:
          "오실레이터 지표들이 과매도 상태에서 더 하락을 시사해요. 추가 하락 위험이 있습니다 📉",
        매도: "오실레이터 지표들이 부정적 신호를 보이고 있어요. 단기 반등은 제한적일 수 있습니다 😕",
        중립: "오실레이터 지표들이 중립 상태예요. 횡보하거나 방향성을 찾고 있습니다 😐",
        매수: "오실레이터 지표들이 긍정적 신호를 보이고 있어요! 반등 가능성이 높아지고 있습니다 👍",
        적극매수:
          "오실레이터 지표들이 강한 상승 신호를 보이고 있어요! 과매도에서 반등 중입니다 🚀",
      },
    },
  },

  // 6. 평가 지표 평가 (밸류에이션)
  평가지표평가: {
    주가수익비율: {
      지표명: "price_earnings_ttm",
      한글명: "P/E 비율",
      단계별범위: {
        매우우수: { min: -Infinity, max: 10, score: 5 },
        우수: { min: 10, max: 15, score: 4 },
        적정: { min: 15, max: 40, score: 3 },
        높음: { min: 40, max: 60, score: 2 },
        매우높음: { min: 60, max: Infinity, score: 1 },
      },
      단계별해석: {
        매우높음:
          "수익 대비 매우 고평가되어 있습니다. 매도를 고려하는 것이 좋습니다 📈😰",
        높음: "수익 대비 다소 고평가되어 있습니다. 리스크 점검이 필요합니다 📊😕",
        적정: "수익 대비 적정한 수준으로 평가됩니다. 보유 관점에서 접근할 수 있습니다 😊",
        우수: "수익 대비 저평가되어 있습니다. 매수 관점으로 볼 수 있습니다 👍",
        매우우수:
          "수익 대비 매우 저평가되어 있습니다. 적극적인 매수 검토가 필요합니다 🚀",
      },
    },
    주가수익성장률: {
      지표명: "price_earnings_growth_ttm",
      한글명: "PEG 비율",
      단계별범위: {
        매우우수: { min: -Infinity, max: 0.5, score: 5 },
        우수: { min: 0.5, max: 1.0, score: 4 },
        적정: { min: 1.0, max: 2.0, score: 3 },
        위험: { min: 2.0, max: 3.0, score: 2 },
        매우위험: { min: 3.0, max: Infinity, score: 1 },
      },
      단계별해석: {
        매우위험:
          "성장 대비 매우 고평가되어 있습니다. 매도하거나 피하는 것이 바람직합니다 📈😰",
        위험: "성장 대비 다소 고평가되어 있습니다. 주의가 요구됩니다 📊😕",
        적정: "성장 대비 적정한 수준입니다. 유지해도 무방합니다 😊",
        우수: "성장 대비 저평가된 수준입니다. 매수 고려가 가능합니다 👍",
        매우우수:
          "성장 대비 매우 저평가되어 있습니다. 뛰어난 투자 기회입니다 🚀",
      },
    },
    주가매출비율: {
      지표명: "price_sales_current",
      한글명: "P/S 비율",
      단계별범위: {
        매우우수: { min: -Infinity, max: 1, score: 5 },
        우수: { min: 1, max: 2, score: 4 },
        적정: { min: 2, max: 7, score: 3 },
        위험: { min: 7, max: 15, score: 2 },
        매우위험: { min: 15, max: Infinity, score: 1 },
      },
      단계별해석: {
        매우위험:
          "매출 대비 매우 고평가되어 있습니다. 투자에 신중해야 합니다 📈😰",
        위험: "매출 대비 다소 고평가되어 있습니다. 추가 분석이 필요합니다 📊😕",
        적정: "매출 대비 적정한 밸류에이션입니다. 중립적인 태도가 적절합니다 😊",
        우수: "매출 대비 저평가되어 있습니다. 긍정적인 신호입니다 👍",
        매우우수:
          "매출 대비 매우 저평가되어 있습니다. 훌륭한 투자 기회입니다 🚀",
      },
    },
    주가순자산비율: {
      지표명: "price_book_fq",
      한글명: "P/B 비율",
      단계별범위: {
        매우우수: { min: -Infinity, max: 1, score: 5 },
        우수: { min: 1, max: 2, score: 4 },
        적정: { min: 2, max: 5, score: 3 },
        위험: { min: 5, max: 10, score: 2 },
        매우위험: { min: 10, max: Infinity, score: 1 },
      },
      단계별해석: {
        매우위험:
          "자산 대비 매우 고평가되어 있습니다. 매도를 고려해야 합니다 📈😰",
        위험: "자산 대비 다소 고평가되어 있습니다. 매도 여부를 검토할 필요가 있습니다 📊😕",
        적정: "자산 대비 적정 수준입니다. 보유 전략이 적절합니다 😊",
        우수: "자산 대비 저평가되어 있습니다. 매수 관점이 유효합니다 👍",
        매우우수:
          "자산 대비 매우 저평가되어 있습니다. 뛰어난 가치투자 기회입니다 🚀",
      },
    },
    주가현금흐름비율: {
      지표명: "price_to_cash_f_operating_activities_ttm",
      한글명: "P/CF 비율",
      단계별범위: {
        매우우수: { min: -Infinity, max: 5, score: 5 },
        우수: { min: 5, max: 10, score: 4 },
        적정: { min: 10, max: 20, score: 3 },
        위험: { min: 20, max: 30, score: 2 },
        매우위험: { min: 30, max: Infinity, score: 1 },
      },
      단계별해석: {
        매우위험:
          "현금흐름 대비 매우 고평가되어 있습니다. 리스크가 큽니다 📈😰",
        위험: "현금흐름 대비 다소 고평가되어 있습니다. 투자 판단에 신중함이 요구됩니다 📊😕",
        적정: "현금흐름 대비 적정 수준입니다. 지속 관찰이 필요합니다 😊",
        우수: "현금흐름 대비 저평가 상태입니다. 투자에 유리할 수 있습니다 👍",
        매우우수:
          "현금흐름 대비 매우 저평가되어 있습니다. 현금창출력 대비 훌륭한 기회입니다 🚀",
      },
    },
    주가잉여현금흐름: {
      지표명: "price_free_cash_flow_ttm",
      한글명: "P/FCF 비율",
      단계별범위: {
        매우우수: { min: -Infinity, max: 10, score: 5 },
        우수: { min: 10, max: 15, score: 4 },
        적정: { min: 15, max: 25, score: 3 },
        위험: { min: 25, max: 50, score: 2 },
        매우위험: { min: 50, max: Infinity, score: 1 },
      },
      단계별해석: {
        매우위험:
          "잉여현금흐름 대비 매우 고평가되어 있습니다. 투자에 주의가 필요합니다 📈😰",
        위험: "잉여현금흐름 대비 다소 고평가되어 있습니다. 리스크 관리가 필요합니다 📊😕",
        적정: "잉여현금흐름 대비 적정한 수준입니다. 중립적 입장을 유지할 수 있습니다 😊",
        우수: "잉여현금흐름 대비 저평가되어 있습니다. 매수 전략이 유효합니다 👍",
        매우우수:
          "잉여현금흐름 대비 매우 저평가되어 있습니다. 탁월한 투자 기회입니다 🚀",
      },
    },
    주가현금비율: {
      지표명: "price_to_cash_ratio",
      한글명: "Price/Cash 비율",
      단계별범위: {
        매우우수: { min: -Infinity, max: 5, score: 5 },
        우수: { min: 5, max: 10, score: 4 },
        적정: { min: 10, max: 20, score: 3 },
        위험: { min: 20, max: 40, score: 2 },
        매우위험: { min: 40, max: Infinity, score: 1 },
      },
      단계별해석: {
        매우위험:
          "현금 대비 매우 고평가되어 있습니다. 매도를 검토해야 합니다 📈😰",
        위험: "현금 대비 다소 고평가되어 있습니다. 신중한 접근이 필요합니다 📊😕",
        적정: "현금 대비 적정 수준입니다. 보유해도 무방합니다 😊",
        우수: "현금 대비 저평가되어 있습니다. 투자 매력도가 높습니다 👍",
        매우우수:
          "현금 대비 매우 저평가되어 있습니다. 현금보유량 대비 매우 매력적입니다 🚀",
      },
    },
    EV매출비율: {
      지표명: "enterprise_value_to_revenue_ttm",
      한글명: "EV/Revenue 비율",
      단계별범위: {
        매우우수: { min: -Infinity, max: 1, score: 5 },
        우수: { min: 1, max: 5, score: 4 },
        적정: { min: 5, max: 10, score: 3 },
        위험: { min: 10, max: 20, score: 2 },
        매우위험: { min: 20, max: Infinity, score: 1 },
      },
      단계별해석: {
        매우위험:
          "수익 대비 매우 고평가되어 있습니다. 투자에 신중해야 합니다 📈😰",
        위험: "수익 대비 다소 고평가되어 있습니다. 위험요소를 검토해야 합니다 📊😕",
        적정: "수익 대비 적정 수준입니다. 중립적인 관점이 필요합니다 😊",
        우수: "수익 대비 저평가된 상황입니다. 매수 고려가 가능합니다 👍",
        매우우수:
          "수익 대비 매우 저평가되어 있습니다. 기업가치 대비 훌륭한 기회입니다 🚀",
      },
    },
    EV영업이익비율: {
      지표명: "enterprise_value_to_ebit_ttm",
      한글명: "EV/EBIT 비율",
      단계별범위: {
        매우우수: { min: -Infinity, max: 6, score: 5 },
        우수: { min: 6, max: 10, score: 4 },
        적정: { min: 10, max: 20, score: 3 },
        위험: { min: 20, max: 30, score: 2 },
        매우위험: { min: 30, max: Infinity, score: 1 },
      },
      단계별해석: {
        매우위험:
          "영업이익 대비 매우 고평가되어 있습니다. 매도를 고려해야 합니다 📈😰",
        위험: "영업이익 대비 다소 고평가되어 있습니다. 리스크 검토가 필요합니다 📊😕",
        적정: "영업이익 대비 적정한 밸류에이션입니다. 보유에 무리가 없습니다 😊",
        우수: "영업이익 대비 저평가되어 있습니다. 긍정적인 접근이 필요합니다 👍",
        매우우수:
          "영업이익 대비 매우 저평가되어 있습니다. 영업실적 대비 뛰어난 기회입니다 🚀",
      },
    },
    EV에비타비율: {
      지표명: "enterprise_value_ebitda_ttm",
      한글명: "EV/EBITDA 비율",
      단계별범위: {
        매우우수: { min: -Infinity, max: 6, score: 5 },
        우수: { min: 6, max: 10, score: 4 },
        적정: { min: 10, max: 15, score: 3 },
        위험: { min: 15, max: 25, score: 2 },
        매우위험: { min: 25, max: Infinity, score: 1 },
      },
      단계별해석: {
        매우위험:
          "EBITDA 대비 매우 고평가되어 있습니다. 주의가 필요합니다 📈😰",
        위험: "EBITDA 대비 다소 고평가되어 있습니다. 추가 분석이 요구됩니다 📊😕",
        적정: "EBITDA 대비 적정한 수준입니다. 중립적으로 볼 수 있습니다 😊",
        우수: "EBITDA 대비 저평가되어 있습니다. 매수 기회로 판단될 수 있습니다 👍",
        매우우수:
          "EBITDA 대비 매우 저평가되어 있습니다. 현금창출력 대비 탁월한 기회입니다 🚀",
      },
    },
  },
};

// 지표별 해석 메시지
const SCORE_INTERPRETATIONS = {
  지표별해석: {
    오버뷰: {
      5: "전반적으로 매우 우수한 기업입니다! 모든 지표가 긍정적이에요 🌟",
      4: "전반적으로 우수한 기업입니다! 대부분의 지표가 양호해요 🚀",
      3: "전반적으로 적정한 기업입니다. 안정적인 성과를 보여줘요 😊",
      2: "전반적으로 다소 아쉬운 기업입니다. 개선이 필요해 보여요 😕",
      1: "전반적으로 부정적인 기업입니다. 주의가 필요한 상황이에요 😰",
      0: "전반적으로 매우 부정적인 기업입니다. 신중한 접근이 필요해요 🚨",
    },
    손익계산평가: {
      5: "손익계산서 지표들이 매우 우수합니다! 탁월한 성장성을 보이고 있어요 🚀",
      4: "손익계산서 지표들이 양호합니다! 좋은 성장 추세를 보이고 있어요 👍",
      3: "손익계산서 지표들이 적정 수준입니다. 안정적인 성과를 유지하고 있어요 😊",
      2: "손익계산서 지표들이 다소 아쉽습니다. 개선이 필요해 보여요 😕",
      1: "손익계산서 지표들이 부정적입니다. 주의가 필요한 상황이에요 😰",
      0: "손익계산서 지표들이 매우 부정적입니다. 신중한 접근이 필요해요 🚨",
    },
    수익성지표평가: {
      5: "수익성 지표들이 매우 우수합니다! 탁월한 수익 창출 능력을 보여줘요 🚀",
      4: "수익성 지표들이 양호합니다! 효율적인 수익 구조를 가지고 있어요 👍",
      3: "수익성 지표들이 적정 수준입니다. 안정적인 수익성을 유지하고 있어요 😊",
      2: "수익성 지표들이 다소 아쉽습니다. 수익성 개선이 필요해 보여요 😕",
      1: "수익성 지표들이 낮습니다. 수익 구조 점검이 필요한 상황이에요 😰",
      0: "수익성 지표들이 매우 낮습니다. 수익성 개선이 시급해요 🚨",
    },
    배당지표평가: {
      5: "배당 지표들이 매우 우수합니다! 훌륭한 배당주로 평가됩니다 💎",
      4: "배당 지표들이 양호합니다! 안정적인 배당 정책을 보여줘요 👍",
      3: "배당 지표들이 적정 수준입니다. 기본적인 배당 매력도가 있어요 😊",
      2: "배당 지표들이 다소 아쉽습니다. 배당 정책을 지켜봐야겠어요 😕",
      1: "배당 지표들이 부족합니다. 배당 투자로는 한계가 있어 보여요 😰",
      0: "배당 지표들이 매우 부족합니다. 배당 투자 매력도가 낮아요 🚨",
    },
    대차대조표평가: {
      5: "재무 안정성이 매우 우수합니다! 탁월한 재무 건전성을 보여줘요 💎",
      4: "재무 안정성이 양호합니다! 건전한 재무 구조를 가지고 있어요 👍",
      3: "재무 안정성이 적정 수준입니다. 안정적인 재무 상태를 유지해요 😊",
      2: "재무 안정성이 다소 우려됩니다. 재무 관리에 주의가 필요해요 😕",
      1: "재무 안정성이 위험합니다. 재무 구조 개선이 필요한 상황이에요 😰",
      0: "재무 안정성이 매우 위험합니다. 재무 위험이 매우 높아요 🚨",
    },
    기술등급평가: {
      5: "기술적 분석 신호가 매우 긍정적입니다! 강력한 매수 신호예요 🚀",
      4: "기술적 분석 신호가 긍정적입니다! 매수를 고려해볼만 해요 👍",
      3: "기술적 분석 신호가 중립적입니다. 추가 신호를 기다려보세요 😊",
      2: "기술적 분석 신호가 다소 부정적입니다. 신중한 접근이 필요해요 😕",
      1: "기술적 분석 신호가 부정적입니다. 주의가 필요한 상황이에요 😰",
      0: "기술적 분석 신호가 매우 부정적입니다. 매도를 고려해보세요 🚨",
    },
    평가지표평가: {
      5: "밸류에이션이 매우 매력적입니다! 뛰어난 투자 기회로 보입니다 🚀",
      4: "밸류에이션이 매력적입니다! 저평가된 상황으로 판단됩니다 👍",
      3: "밸류에이션이 적정 수준입니다. 공정한 가치로 평가되고 있어요 😊",
      2: "밸류에이션이 다소 높습니다. 고평가 우려가 있어 보여요 😕",
      1: "밸류에이션이 높습니다. 고평가 상태로 주의가 필요해요 😰",
      0: "밸류에이션이 매우 높습니다. 고평가 위험이 매우 커요 🚨",
    },
  },
  종합해석: {
    5: "전체적으로 매우 우수한 투자처입니다! 모든 면에서 탁월한 성과를 보여줍니다 🌟",
    4: "전체적으로 우수한 투자처입니다! 대부분의 지표가 양호한 수준이에요 🚀",
    3: "전체적으로 적정한 투자처입니다. 안정적이고 균형잡힌 모습을 보여줘요 😊",
    2: "전체적으로 다소 아쉬운 투자처입니다. 일부 개선이 필요해 보여요 😕",
    1: "전체적으로 부족한 투자처입니다. 여러 지표에서 주의가 필요한 상황이에요 😰",
    0: "전체적으로 위험한 투자처입니다. 신중한 검토가 반드시 필요해요 🚨",
  },
};

/**
 * 개별 지표의 점수 계산
 */
function calculateIndicatorScore(
  value,
  ranges,
  interpretations = null,
  indicatorName = null
) {
  if (value == null || value === undefined || isNaN(value)) {
    return {
      score: 0,
      grade: "데이터없음",
      interpretation: "데이터를 확인할 수 없습니다 ❓",
    };
  }

  for (const [grade, range] of Object.entries(ranges)) {
    if (value >= range.min && value < range.max) {
      return {
        score: parseFloat(range.score?.toFixed(2)),
        grade: grade,
        interpretation:
          interpretations?.[grade] ||
          getInterpretationByGrade(grade, indicatorName),
      };
    }
  }

  // 범위를 벗어나는 경우 가장 가까운 범위의 점수 사용
  const grades = Object.keys(ranges);
  const firstGrade = grades[0];
  const lastGrade = grades[grades.length - 1];

  if (value < ranges[firstGrade].min) {
    return {
      score: parseFloat(ranges[firstGrade].score?.toFixed(2)),
      grade: firstGrade,
      interpretation:
        interpretations?.[firstGrade] ||
        getInterpretationByGrade(firstGrade, indicatorName),
    };
  } else {
    return {
      score: parseFloat(ranges[lastGrade].score?.toFixed(2)),
      grade: lastGrade,
      interpretation:
        interpretations?.[lastGrade] ||
        getInterpretationByGrade(lastGrade, indicatorName),
    };
  }
}

/**
 * 등급별 해석 메시지 가져오기 (실제 평가 해석 우선 사용)
 */
function getInterpretationByGrade(grade, indicatorName = null) {
  // 지표별 상세 해석 매핑
  const detailedInterpretations = {
    // 오버뷰 관련 해석
    relative_volume_10d_calc: {
      매우낮음:
        "거래량이 평소보다 매우 적어요. 관심이 낮거나 유동성이 부족할 수 있습니다 😕",
      낮음: "거래량이 평소보다 적어요. 시장 참여가 소극적인 상황입니다 😐",
      적정: "적정한 거래량 수준이에요. 평소와 비슷한 관심도를 보이고 있어요 😊",
      높음: "거래량이 평소보다 많아요! 시장의 관심이 높아지고 있습니다 👍",
      매우높음: "거래량이 폭증했어요! 중요한 이슈나 변화가 있을 수 있습니다 🚀",
    },
    recommendation_mark: {
      매우낮음:
        "애널리스트들이 매우 부정적으로 평가하고 있어요. 투자에 주의가 필요합니다 😰",
      낮음: "애널리스트들이 다소 부정적으로 평가하고 있어요. 신중한 접근이 필요해요 😕",
      적정: "애널리스트들이 중립적으로 평가하고 있어요. 균형잡힌 시각을 보이고 있습니다 😊",
      양호: "애널리스트들이 긍정적으로 평가하고 있어요! 전문가들의 신뢰를 받고 있습니다 👍",
      매우우수:
        "애널리스트들이 매우 긍정적으로 평가하고 있어요! 강력한 매수 추천을 받고 있습니다 🚀",
    },
    price_target_1y_delta: {
      매우부정적:
        "목표가 대비 현재 주가가 크게 높아요. 고평가 위험이 있을 수 있습니다 😰",
      부정적:
        "목표가 대비 현재 주가가 다소 높아요. 상승 여력이 제한적일 수 있어요 😕",
      적정: "목표가 대비 적정한 주가 수준이에요. 합리적인 가격으로 평가됩니다 😊",
      양호: "목표가 대비 상승 여력이 있어요! 추가 상승 가능성을 보여줍니다 👍",
      매우우수:
        "목표가 대비 상당한 상승 여력이 있어요! 큰 상승 잠재력을 가지고 있습니다 🚀",
    },

    // 기술등급 관련 해석
    recommend_all: {
      적극매도: "기술적 분석 신호가 매우 부정적이에요. 매도를 고려해보세요 📉",
      매도: "기술적 분석 신호가 부정적이에요. 신중한 접근이 필요합니다 😕",
      중립: "기술적 분석 신호가 중립적이에요. 추가 신호를 기다려보세요 😐",
      매수: "기술적 분석 신호가 긍정적이에요! 매수를 고려해볼만 합니다 👍",
      적극매수:
        "기술적 분석 신호가 매우 긍정적이에요! 강력한 매수 신호입니다 🚀",
    },
    recommend_m_a: {
      적극매도:
        "이동평균선이 강한 하락 신호를 보이고 있어요. 하락 추세가 뚜렷합니다 📉",
      매도: "이동평균선이 하락 신호를 보이고 있어요. 단기 조정이 예상됩니다 😕",
      중립: "이동평균선이 혼조세를 보이고 있어요. 방향성이 불분명합니다 😐",
      매수: "이동평균선이 상승 신호를 보이고 있어요! 상승 추세 진입 가능성이 있습니다 👍",
      적극매수:
        "이동평균선이 강한 상승 신호를 보이고 있어요! 뚜렷한 상승 추세입니다 🚀",
    },
    recommend_other: {
      적극매도:
        "오실레이터 지표들이 과매도 상태에서 더 하락을 시사해요. 추가 하락 위험이 있습니다 📉",
      매도: "오실레이터 지표들이 부정적 신호를 보이고 있어요. 단기 반등은 제한적일 수 있습니다 😕",
      중립: "오실레이터 지표들이 중립 상태예요. 횡보하거나 방향성을 찾고 있습니다 😐",
      매수: "오실레이터 지표들이 긍정적 신호를 보이고 있어요! 반등 가능성이 높아지고 있습니다 👍",
      적극매수:
        "오실레이터 지표들이 강한 상승 신호를 보이고 있어요! 과매도에서 반등 중입니다 🚀",
    },
    // 수익성 관련 해석
    gross_margin_ttm: {
      매우낮음:
        "총마진이 음수예요. 원가가 매출보다 높아 매우 위험한 상황입니다 😰",
      낮음: "총마진이 낮아요. 원가 관리나 가격 정책을 개선할 필요가 있어 보여요 😕",
      적정: "적정한 총마진이에요. 기본적인 수익성은 확보하고 있어요 😊",
      양호: "좋은 총마진이에요! 제품/서비스의 경쟁력이 우수합니다 👍",
      매우우수:
        "매우 높은 총마진이에요! 강력한 경쟁우위를 가진 사업모델입니다 🚀",
    },
    operating_margin_ttm: {
      매우낮음: "영업적자 상태예요. 사업 구조 개선이 시급합니다 😰",
      낮음: "영업마진이 낮아요. 운영 효율성을 높일 필요가 있어요 😕",
      적정: "적당한 영업마진이에요. 기본적인 사업성은 확보했어요 😊",
      양호: "좋은 영업마진이에요! 효율적인 운영을 하고 있습니다 👍",
      매우우수: "매우 높은 영업마진이에요! 탁월한 운영 효율성을 보여줍니다 🚀",
    },
    // 손익계산 관련 해석
    total_revenue_yoy_growth_ttm: {
      매우부정적:
        "매출이 크게 감소하고 있어요. 사업 기반이 흔들리고 있을 수 있습니다 😰",
      부정적:
        "매출이 감소하고 있어요. 시장 상황이나 경쟁력을 점검해봐야 합니다 😕",
      적정: "안정적인 매출 성장을 보이고 있어요. 꾸준한 성장세를 유지하고 있습니다 😊",
      양호: "좋은 매출 성장률이에요! 시장에서 좋은 성과를 거두고 있습니다 👍",
      매우우수:
        "매우 높은 매출 성장률이에요! 폭발적인 성장을 하고 있는 기업입니다 🚀",
    },
    earnings_per_share_diluted_yoy_growth_ttm: {
      매우부정적:
        "주당순이익이 크게 감소했어요. 수익성이 급격히 악화되고 있습니다 😰",
      부정적: "주당순이익이 감소했어요. 수익성 개선이 필요한 상황입니다 😕",
      적정: "안정적인 주당순이익 성장을 보이고 있어요. 꾸준한 수익 증가세입니다 😊",
      양호: "좋은 주당순이익 성장률이에요! 수익성이 크게 개선되고 있습니다 👍",
      매우우수:
        "매우 높은 주당순이익 성장률이에요! 폭발적인 수익 증가를 보이고 있습니다 🚀",
    },
  };

  // 지표별 상세 해석이 있으면 사용, 없으면 기본 해석 사용
  if (indicatorName && detailedInterpretations[indicatorName]?.[grade]) {
    return detailedInterpretations[indicatorName][grade];
  }

  // 기본 해석
  const interpretations = {
    매우우수: "매우 우수한 수준입니다! 🚀",
    적극매수: "적극적인 매수 신호입니다! 🚀",
    양호: "양호한 수준입니다! 👍",
    우수: "우수한 수준입니다! 👍",
    매수: "매수 신호입니다! 👍",
    적정: "적정한 수준입니다 😊",
    중립: "중립적인 상황입니다 😊",
    부정적: "다소 부정적입니다 😕",
    낮음: "낮은 수준입니다 😕",
    위험: "위험한 수준입니다 😕",
    매도: "매도 신호입니다 😕",
    높음: "높은 수준입니다 😕",
    매우부정적: "매우 부정적입니다 😰",
    매우낮음: "매우 낮은 수준입니다 😰",
    매우위험: "매우 위험합니다 😰",
    적극매도: "적극적인 매도 신호입니다 😰",
    매우높음: "매우 높은 수준입니다 🚨",
    데이터없음: "데이터를 확인할 수 없습니다 ❓",
  };

  return interpretations[grade] || "평가 불가 ❓";
}

/**
 * 점수를 기반으로 한 해석 메시지 가져오기
 */
function getInterpretationByScore(score, category = "종합해석") {
  const roundedScore = Math.round(score);
  const clampedScore = Math.max(0, Math.min(5, roundedScore));

  if (category === "종합해석") {
    return SCORE_INTERPRETATIONS.종합해석[clampedScore] || "평가 불가";
  } else {
    return (
      SCORE_INTERPRETATIONS.지표별해석[category]?.[clampedScore] || "평가 불가"
    );
  }
}

/**
 * 지표별 분석 수행
 */
function analyzeCategory(categoryName, indicators, stockData) {
  const results = {};
  const scores = [];

  Object.entries(indicators).forEach(([indicatorKey, config]) => {
    const value = stockData[config.지표명];
    const result = calculateIndicatorScore(
      value,
      config.단계별범위,
      config.단계별해석, // 실제 평가 해석 전달
      config.지표명 // 지표명 전달 (상세 해석용)
    );

    results[indicatorKey] = {
      지표명: config.지표명,
      한글명: config.한글명,
      현재값: value,
      점수: result.score,
      등급: result.grade,
      해석: result.interpretation,
    };

    if (result.score > 0) {
      // 데이터가 있는 경우만 평균 계산에 포함
      scores.push(result.score);
    }
  });

  const averageScore =
    scores.length > 0
      ? parseFloat(
          (scores.reduce((a, b) => a + b, 0) / scores.length)?.toFixed(2)
        )
      : 0;

  return {
    지표들: results,
    평균점수: averageScore,
    해석: getInterpretationByScore(averageScore, categoryName),
    데이터개수: scores.length,
  };
}

/**
 * 종합 주식 분석
 */
function analyzeStock(stockData) {
  const analysis = {};
  const categoryScores = [];

  // 6가지 지표별 분석
  Object.entries(INDICATOR_EVALUATIONS).forEach(
    ([categoryName, indicators]) => {
      const categoryResult = analyzeCategory(
        categoryName,
        indicators,
        stockData
      );
      analysis[categoryName] = categoryResult;

      if (categoryResult.평균점수 > 0) {
        categoryScores.push(categoryResult.평균점수);
      }
    }
  );

  // 종합 점수 계산
  const totalScore =
    categoryScores.length > 0
      ? parseFloat(
          (
            categoryScores.reduce((a, b) => a + b, 0) / categoryScores.length
          )?.toFixed(2)
        )
      : 0;

  analysis.종합평가 = {
    총점수: totalScore,
    해석: getInterpretationByScore(totalScore),
    평가된지표수: categoryScores.length,
    지표별점수: Object.fromEntries(
      Object.entries(analysis).map(([key, value]) => [key, value.평균점수])
    ),
  };

  return analysis;
}

/**
 * 예시 사용법
 */
function exampleAnalysis() {
  const sampleStock = {
    // 손익계산 예시 데이터
    total_revenue_yoy_growth_ttm: 25.5,
    earnings_per_share_diluted_yoy_growth_ttm: 35.2,

    // 수익성 예시 데이터
    gross_margin_ttm: 45.3,
    operating_margin_ttm: 18.7,
    return_on_assets_fq: 12.4,
    return_on_equity_fq: 18.9,

    // 배당 예시 데이터
    continuous_dividend_payout: 12,
    continuous_dividend_growth: 8,
    dividends_yield_current: 3.2,

    // 대차대조표 예시 데이터
    current_ratio_fq: 2.1,
    debt_to_equity_fq: 0.45,

    // 기술등급 예시 데이터
    "Recommend.All": 0.25,
    "Recommend.MA": 0.15,

    // 평가지표 예시 데이터
    price_earnings_ttm: 22.5,
    price_earnings_growth_ttm: 1.3,
    price_sales_current: 3.2,
  };

  const result = analyzeStock(sampleStock);

  console.log("📊 종목 분석 결과:");
  console.log("=".repeat(50));

  // 각 지표별 결과 출력
  Object.entries(result).forEach(([categoryName, categoryData]) => {
    if (categoryName !== "종합평가") {
      console.log(`\n🎯 ${categoryName}:`);
      console.log(`   평균 점수: ${categoryData.평균점수}/5.00점`);
      console.log(`   해석: ${categoryData.해석}`);

      Object.entries(categoryData.지표들).forEach(([indicatorName, data]) => {
        console.log(
          `   - ${data.한글명}: ${data.현재값} → ${data.점수}/5.00점 (${data.등급})`
        );
      });
    }
  });

  // 종합 평가
  console.log("\n🌟 종합 평가:");
  console.log(`   총 점수: ${result.종합평가.총점수}/5.00점`);
  console.log(`   해석: ${result.종합평가.해석}`);
  console.log(`   평가된 지표수: ${result.종합평가.평가된지표수}개`);

  return result;
}

// 웹 워커에서 사용 시 전역으로 노출
if (typeof self !== "undefined" && typeof window === "undefined") {
  self.analyzeStock = analyzeStock;
  self.calculateIndicatorScore = calculateIndicatorScore;
  self.INDICATOR_EVALUATIONS = INDICATOR_EVALUATIONS;
}

// 모듈 내보내기
if (typeof module !== "undefined" && module.exports) {
  module.exports = {
    analyzeStock,
    calculateIndicatorScore,
    INDICATOR_EVALUATIONS,
    SCORE_INTERPRETATIONS,
  };
}

// 브라우저에서 직접 실행 시
if (typeof window !== "undefined") {
  window.StockAnalyzer = {
    analyzeStock,
    calculateIndicatorScore,
    INDICATOR_EVALUATIONS,
    SCORE_INTERPRETATIONS,
  };
}

// 직접 실행 시 예시 출력
if (typeof require !== "undefined" && require.main === module) {
  exampleAnalysis();
}
